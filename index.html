<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>テニスコート確保作業サイト</title>
<style>
body {
  font-family: Meiryo, sans-serif;
  font-size: 14px;
}
h1 {
  font-size: 16px;
}
table {
  border-collapse: collapse;
  margin-top: 10px;
}
td, th {
  border: 1px solid #999;
  padding: 4px 6px;
}
.name {
  cursor: pointer;
}
.name.on {
  color: red;
  font-weight: bold;
}
#uploadArea {
  margin-top: 20px;
}
button {
  margin-right: 10px;
}
</style>
</head>

<body>
<h1>テニスコート確保作業サイト</h1>

<div id="content">
  <p id="message">「抽選申込作業依頼書（Excel）」をアップロードしてください。</p>
  <input type="file" id="fileInput" accept=".xlsx,.xls">
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
const GITHUB_OWNER = "tennis-user";
const GITHUB_REPO  = "tennis-court-site";
const GITHUB_TOKEN = "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";
const JSON_PATH = "data.json";

const API_URL = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${JSON_PATH}`;

let currentData = null;
let currentSha = null;

async function loadFromGitHub() {
  const res = await fetch(API_URL, {
    headers: {
      "Authorization": "token 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",
    }
  });

  if (!res.ok) return;

  const json = await res.json();
  currentSha = json.sha;
  const decoded = JSON.parse(atob(json.content));
  currentData = decoded;
  renderTable(decoded);
}

async function saveToGitHub(data) {
  const body = {
    message: "update data",
    content: btoa(unescape(encodeURIComponent(JSON.stringify(data)))),
    sha: currentSha
  };

  const res = await fetch(API_URL, {
    method: "PUT",
    headers: {
      "Authorization": "token " + GITHUB_TOKEN,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body)
  });

  const json = await res.json();
  currentSha = json.content.sha;
}

function renderTable(data) {
  const content = document.getElementById("content");
  content.innerHTML = "";

  const table = document.createElement("table");

  data.forEach(row => {
    const tr = document.createElement("tr");
    row.forEach(cell => {
      const td = document.createElement("td");
      td.textContent = cell.text;
      if (cell.isName) {
        td.className = "name" + (cell.on ? " on" : "");
        td.onclick = () => {
          cell.on = !cell.on;
          saveToGitHub(currentData);
          renderTable(currentData);
        };
      }
      tr.appendChild(td);
    });
    table.appendChild(tr);
  });

  content.appendChild(table);

  const uploadArea = document.createElement("div");
  uploadArea.id = "uploadArea";

  const newBtn = document.createElement("button");
  newBtn.textContent = "新しい抽選申込作業依頼書のアップロード";

  newBtn.onclick = () => {
    uploadArea.innerHTML = "";
    const fileInput = document.createElement("input");
    fileInput.type = "file";
    fileInput.accept = ".xlsx,.xls";
    fileInput.onchange = handleExcel;

    const cancelBtn = document.createElement("button");
    cancelBtn.textContent = "何もせずに戻る";
    cancelBtn.onclick = () => renderTable(currentData);

    uploadArea.appendChild(fileInput);
    uploadArea.appendChild(cancelBtn);
  };

  uploadArea.appendChild(newBtn);
  content.appendChild(uploadArea);
}

function handleExcel(e) {
  const file = e.target.files[0];
  const reader = new FileReader();

  reader.onload = evt => {
    const wb = XLSX.read(evt.target.result, {type: "binary"});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, {header: 1});

    currentData = rows.map(r =>
      r.map(c => ({
        text: c ?? "",
        isName: typeof c === "string" && c.trim() !== "",
        on: false
      }))
    );

    saveToGitHub(currentData);
    renderTable(currentData);
  };

  reader.readAsBinaryString(file);
}

document.getElementById("fileInput").addEventListener("change", handleExcel);

loadFromGitHub();
</script>
</body>
</html>
