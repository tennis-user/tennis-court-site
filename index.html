<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>テニスコート確保作業用Webサイト</title>
<style>
  body {
    font-family: sans-serif;
  }
  table {
    border-collapse: collapse;
    margin-top: 20px;
  }
  td {
    border: 1px solid #666;
    padding: 4px 8px;
    text-align: center;
    min-width: 40px;
  }
  .winner {
    color: red;
    font-weight: bold;
  }
</style>
</head>
<body>

<h2>テニスコート確保作業用Webサイト（確定版）</h2>

<div id="tableArea">読み込み中...</div>

<script>
fetch('data/current_data.json')
  .then(res => res.json())
  .then(data => render(data))
  .catch(() => {
    document.getElementById('tableArea').textContent =
      'データを読み込めませんでした';
  });

function render(data) {
  const range = decodeRange(data.ref);
  const table = document.createElement('table');

  for (let r = range.s.r; r <= range.e.r; r++) {
    const tr = document.createElement('tr');
    for (let c = range.s.c; c <= range.e.c; c++) {
      const cellId = encodeCell(r, c);

      if (isMergedChild(cellId, data.merges)) continue;

      const td = document.createElement('td');
      td.textContent = data.excel[cellId] ?? '';

      const merge = getMerge(cellId, data.merges);
      if (merge) {
        td.rowSpan = merge.e.r - merge.s.r + 1;
        td.colSpan = merge.e.c - merge.s.c + 1;
      }

      if (data.winners[cellId]) {
        td.classList.add('winner');
      }

      tr.appendChild(td);
    }
    table.appendChild(tr);
  }

  const area = document.getElementById('tableArea');
  area.innerHTML = '';
  area.appendChild(table);
}

/* --- utility --- */

function encodeCell(r, c) {
  return String.fromCharCode(65 + c) + (r + 1);
}

function decodeRange(ref) {
  const [s, e] = ref.split(':');
  return {
    s: { r: parseInt(s.slice(1)) - 1, c: s.charCodeAt(0) - 65 },
    e: { r: parseInt(e.slice(1)) - 1, c: e.charCodeAt(0) - 65 }
  };
}

function getMerge(cell, merges) {
  return merges.find(m =>
    cell === encodeCell(m.s.r, m.s.c)
  );
}

function isMergedChild(cell, merges) {
  return merges.some(m => {
    const r = parseInt(cell.slice(1)) - 1;
    const c = cell.charCodeAt(0) - 65;
    return (
      (r > m.s.r || c > m.s.c) &&
      r >= m.s.r && r <= m.e.r &&
      c >= m.s.c && c <= m.e.c
    );
  });
}
</script>

</body>
</html>
