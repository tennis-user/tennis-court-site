<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>テニスコート確保作業サイト</title>
<style>
body { font-family: メイリオ, Meiryo, sans-serif; font-size:14px; }
h1 { font-size:16px; }
table { border-collapse:collapse; margin-top:10px; }
td, th { border:1px solid #333; padding:4px 8px; text-align:center; }
.toggle { cursor:pointer; }
.win { color:red; font-weight:bold; }
</style>
</head>
<body>

<h1>テニスコート確保作業サイト</h1>
<input type="file" id="excel" accept=".xlsx">
<div id="view"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
/* ====== ★ あなたが書き換えるのはここだけ ====== */
const GITHUB_OWNER = "tennis-user";
const GITHUB_REPO  = "tennis-court-site";
const GITHUB_TOKEN = "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";
/* ================================================ */

const FILE_NAME = "current_data.json";
const API_URL = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${FILE_NAME}`;
const RAW_URL = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/main/${FILE_NAME}`;

let state = null;

/* 起動時：保存済みJSONを読む */
window.onload = async () => {
  try {
    const r = await fetch(RAW_URL + "?t=" + Date.now());
    if (r.ok) {
      state = await r.json();
      draw(state);
    }
  } catch {}
};

/* Excel読み込み */
document.getElementById("excel").onchange = async e => {
  const buf = await e.target.files[0].arrayBuffer();
  const wb = XLSX.read(buf, { type:"array" });
  const ws = wb.Sheets[wb.SheetNames[0]];

  state = {
    cells: XLSX.utils.sheet_to_json(ws, { header:1, defval:"" }),
    merges: ws["!merges"] || []
  };
  await save(state);
  draw(state);
};

/* 表示（セル結合再現） */
function draw(data){
  const area = document.getElementById("view");
  area.innerHTML = "";
  const tbl = document.createElement("table");
  const skip = {};

  data.merges.forEach(m=>{
    for(let r=m.s.r;r<=m.e.r;r++)
      for(let c=m.s.c;c<=m.e.c;c++)
        if(r!==m.s.r||c!==m.s.c) skip[`${r},${c}`]=1;
  });

  data.cells.forEach((row,r)=>{
    const tr=document.createElement("tr");
    row.forEach((v,c)=>{
      if(skip[`${r},${c}`]) return;
      const td=document.createElement("td");
      const m=data.merges.find(x=>x.s.r===r&&x.s.c===c);
      if(m){ td.rowSpan=m.e.r-m.s.r+1; td.colSpan=m.e.c-m.s.c+1; }
      td.textContent=v;
      td.className="toggle";
      td.onclick=()=>{ td.classList.toggle("win"); save(state); };
      tr.appendChild(td);
    });
    tbl.appendChild(tr);
  });
  area.appendChild(tbl);
}

/* GitHub保存（存在確認→PUT） */
async function save(data){
  let sha=null;
  const g=await fetch(API_URL,{
    headers:{
      Authorization:"token "+GITHUB_TOKEN,
    }
  });
  if(g.ok) sha=(await g.json()).sha;

  await fetch(API_URL,{
    method:"PUT",
    headers:{
      Authorization:"token "+GITHUB_TOKEN,
      "Content-Type":"application/json",
    },
    body:JSON.stringify({
      message:"update",
      content:btoa(unescape(encodeURIComponent(JSON.stringify(data)))),
      sha
    })
  });
}
</script>
</body>
</html>
